<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard TBA 110kV â€“ HÃ  Ná»™i</title>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Barlow:wght@300;400;600;700&display=swap" rel="stylesheet"/>

<style>
/* â”€â”€â”€ DESIGN SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:        #0a0e17;
  --bg2:       #111827;
  --bg3:       #1a2235;
  --border:    #1e3a5f;
  --accent:    #00d4ff;
  --accent2:   #f59e0b;
  --accent3:   #10b981;
  --danger:    #ef4444;
  --text:      #e2e8f0;
  --muted:     #64748b;
  --card-glow: 0 0 30px rgba(0,212,255,.06);
  --font-ui:   'Barlow', sans-serif;
  --font-mono: 'IBM Plex Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-ui);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ SCANLINE TEXTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg,
    transparent, transparent 2px,
    rgba(0,0,0,.05) 2px, rgba(0,0,0,.05) 4px);
  pointer-events: none; z-index: 9999;
}

/* â”€â”€â”€ CONFIG OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#config-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.92);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; backdrop-filter: blur(8px);
}
.config-box {
  background: var(--bg2);
  border: 1px solid var(--accent);
  border-radius: 12px;
  padding: 40px;
  width: 500px;
  box-shadow: 0 0 60px rgba(0,212,255,.2);
}
.config-box h2 {
  font-family: var(--font-mono);
  color: var(--accent);
  font-size: 14px;
  letter-spacing: .15em;
  text-transform: uppercase;
  margin-bottom: 8px;
}
.config-box p { color: var(--muted); font-size: 13px; margin-bottom: 28px; }
.config-box label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-family: var(--font-mono); }
.config-box input {
  width: 100%; padding: 10px 14px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text);
  font-family: var(--font-mono); font-size: 13px;
  margin-bottom: 16px; outline: none;
  transition: border .2s;
}
.config-box input:focus { border-color: var(--accent); }
.config-box .hint {
  background: rgba(0,212,255,.06);
  border: 1px solid rgba(0,212,255,.2);
  border-radius: 6px; padding: 10px 14px;
  font-size: 12px; color: var(--accent);
  font-family: var(--font-mono); margin-bottom: 20px;
  line-height: 1.6;
}
.btn-primary {
  width: 100%; padding: 12px;
  background: var(--accent); color: #000;
  font-weight: 700; font-size: 14px;
  border: none; border-radius: 6px;
  cursor: pointer; letter-spacing: .05em;
  transition: opacity .2s;
}
.btn-primary:hover { opacity: .85; }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  display: flex; align-items: center; gap: 20px;
  height: 60px; position: sticky; top: 0; z-index: 100;
}
.logo-mark {
  width: 36px; height: 36px;
  background: var(--accent); border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-weight: 600;
  font-size: 14px; color: #000;
  flex-shrink: 0;
}
.logo-text { font-weight: 700; font-size: 16px; letter-spacing: .02em; }
.logo-text span { color: var(--accent); }
.header-meta {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 11px; color: var(--muted);
  display: flex; gap: 24px; align-items: center;
}
.status-dot {
  width: 8px; height: 8px;
  background: var(--accent3); border-radius: 50%;
  box-shadow: 0 0 8px var(--accent3);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
#last-updated { color: var(--muted); }
.btn-config {
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--muted); padding: 6px 12px;
  border-radius: 4px; cursor: pointer;
  font-size: 11px; font-family: var(--font-mono);
  transition: all .2s;
}
.btn-config:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { padding: 24px 32px; max-width: 1600px; margin: 0 auto; }

/* â”€â”€â”€ STATS ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px; margin-bottom: 24px;
}
.stat-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 20px 24px;
  position: relative; overflow: hidden;
  box-shadow: var(--card-glow);
  transition: border-color .2s;
}
.stat-card:hover { border-color: var(--accent); }
.stat-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
}
.stat-card.blue::before  { background: var(--accent); }
.stat-card.amber::before { background: var(--accent2); }
.stat-card.green::before { background: var(--accent3); }
.stat-card.red::before   { background: var(--danger); }
.stat-label {
  font-size: 11px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
  margin-bottom: 10px;
}
.stat-value {
  font-size: 36px; font-weight: 700;
  line-height: 1; font-family: var(--font-mono);
}
.stat-card.blue  .stat-value { color: var(--accent); }
.stat-card.amber .stat-value { color: var(--accent2); }
.stat-card.green .stat-value { color: var(--accent3); }
.stat-card.red   .stat-value { color: var(--danger); }
.stat-sub { font-size: 12px; color: var(--muted); margin-top: 6px; }

/* â”€â”€â”€ FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 16px 20px;
  margin-bottom: 20px;
  display: flex; flex-direction: column; gap: 14px;
}
.filter-row {
  display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;
}
.filter-group { display: flex; flex-direction: column; gap: 6px; }
.filter-group label {
  font-size: 10px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
}
.filter-group select,
.filter-group input {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text); padding: 8px 12px;
  border-radius: 6px; font-size: 13px;
  outline: none; min-width: 140px;
  transition: border .2s;
  font-family: var(--font-ui);
}
.filter-group select:focus,
.filter-group input:focus { border-color: var(--accent); }
.filter-group input { min-width: 220px; }
.btn-filter {
  background: var(--accent); color: #000;
  border: none; padding: 9px 20px;
  border-radius: 6px; cursor: pointer;
  font-weight: 700; font-size: 13px;
  transition: opacity .2s; white-space: nowrap;
}
.btn-filter:hover { opacity: .85; }
.btn-reset {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted); padding: 9px 16px;
  border-radius: 6px; cursor: pointer;
  font-size: 13px; transition: all .2s;
}
.btn-reset:hover { border-color: var(--danger); color: var(--danger); }
.btn-preset {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--muted); padding: 6px 10px;
  border-radius: 4px; cursor: pointer;
  font-size: 11px; font-family: var(--font-mono);
  transition: all .2s; white-space: nowrap;
}
.btn-preset:hover  { border-color: var(--accent2); color: var(--accent2); }
.btn-preset.active { border-color: var(--accent2); color: var(--accent2); background: rgba(245,158,11,.12); font-weight:700; }
.filter-count {
  margin-left: auto;
  font-family: var(--font-mono); font-size: 12px;
  color: var(--muted); align-self: center;
}
.filter-count span { color: var(--accent); font-weight: 600; }

/* â”€â”€â”€ CHARTS ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px; margin-bottom: 20px;
}
.chart-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 20px;
  box-shadow: var(--card-glow);
}
.chart-title {
  font-size: 11px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}
.chart-title::before {
  content: ''; width: 3px; height: 12px;
  background: var(--accent); border-radius: 2px;
}
.chart-wrap { height: 200px; position: relative; }

/* â”€â”€â”€ DATA TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden;
  box-shadow: var(--card-glow);
}
.table-header {
  padding: 16px 20px;
  display: flex; align-items: center; gap: 12px;
  border-bottom: 1px solid var(--border);
}
.table-title {
  font-family: var(--font-mono);
  font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: .1em;
}
.table-title::before {
  content: 'â–¶ '; color: var(--accent);
}
.btn-export {
  margin-left: auto;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted); padding: 6px 14px;
  border-radius: 4px; cursor: pointer;
  font-size: 11px; font-family: var(--font-mono);
  transition: all .2s;
}
.btn-export:hover { border-color: var(--accent3); color: var(--accent3); }
.table-scroll { overflow-x: auto; }
table {
  width: 100%; border-collapse: collapse;
  font-size: 13px;
}
thead th {
  background: var(--bg3);
  padding: 10px 14px;
  text-align: left;
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--muted);
  white-space: nowrap;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}
thead th:hover { color: var(--accent); }
thead th.sorted { color: var(--accent); }
tbody tr {
  border-bottom: 1px solid rgba(30,58,95,.5);
  transition: background .15s;
}
tbody tr:hover { background: rgba(0,212,255,.04); }
tbody tr:last-child { border-bottom: none; }
td {
  padding: 10px 14px;
  vertical-align: top;
  max-width: 280px;
}
td.mono { font-family: var(--font-mono); font-size: 12px; }
.badge {
  display: inline-block;
  padding: 2px 8px; border-radius: 20px;
  font-size: 11px; font-family: var(--font-mono);
  font-weight: 600;
}
.badge-tram   { background: rgba(0,212,255,.15); color: var(--accent); }
.badge-110    { background: rgba(239,68,68,.15);  color: var(--danger); }
.badge-35     { background: rgba(245,158,11,.15); color: var(--accent2); }
.badge-22     { background: rgba(16,185,129,.15); color: var(--accent3); }
.badge-other  { background: rgba(100,116,139,.15); color: var(--muted); }
.text-clamp {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  color: var(--text); /* Äá»•i mÃ u chá»¯ sang tráº¯ng sÃ¡ng */
  font-weight: 600;   /* ThÃªm in Ä‘áº­m giá»‘ng cá»™t HÃ£ng SX */
  font-size: 13px;    /* Chá»‰nh cá»¡ chá»¯ báº±ng vá»›i cÃ¡c cá»™t khÃ¡c Ä‘á»ƒ Ä‘á»“ng bá»™ */
}
.btn-detail {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--accent); padding: 4px 10px;
  border-radius: 4px; cursor: pointer;
  font-size: 11px; font-family: var(--font-mono);
  transition: all .2s; white-space: nowrap;
}
.btn-detail:hover { background: rgba(0,212,255,.1); }

/* â”€â”€â”€ PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.pagination button {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text); padding: 6px 12px;
  border-radius: 4px; cursor: pointer;
  font-size: 12px; font-family: var(--font-mono);
  transition: all .2s; min-width: 36px;
}
.pagination button:hover { border-color: var(--accent); color: var(--accent); }
.pagination button.active {
  background: var(--accent); color: #000;
  border-color: var(--accent); font-weight: 700;
}
.pagination button:disabled { opacity: .3; cursor: not-allowed; }
.page-info {
  margin-left: auto;
  font-family: var(--font-mono); font-size: 11px; color: var(--muted);
}

/* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.8);
  display: none; align-items: center; justify-content: center;
  z-index: 500; backdrop-filter: blur(4px);
}
#modal-overlay.open { display: flex; }
.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  width: 680px; max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 0 60px rgba(0,212,255,.15);
}
.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.modal-header h3 {
  font-size: 14px; font-weight: 700;
  flex: 1;
}
.btn-close {
  background: transparent; border: none;
  color: var(--muted); cursor: pointer;
  font-size: 20px; line-height: 1;
  transition: color .2s;
}
.btn-close:hover { color: var(--danger); }
.modal-body { padding: 24px; }
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px; margin-bottom: 20px;
}
.detail-field label {
  font-size: 10px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
  display: block; margin-bottom: 4px;
}
.detail-field value {
  display: block; font-size: 14px;
  font-weight: 600;
}
.detail-field.full { grid-column: 1 / -1; }
.detail-text {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 6px; padding: 12px 14px;
  font-size: 12px; 
  color: var(--text); /* Äá»•i mÃ u tá»« --muted sang --text Ä‘á»ƒ chá»¯ sÃ¡ng lÃªn */
  line-height: 1.7; white-space: pre-wrap;
  max-height: 180px; overflow-y: auto;
}

/* â”€â”€â”€ LOADING / EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading {
  text-align: center; padding: 60px;
  color: var(--muted); font-family: var(--font-mono); font-size: 13px;
}
.loading-spinner {
  width: 32px; height: 32px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty {
  text-align: center; padding: 60px;
  color: var(--muted); font-family: var(--font-mono); font-size: 13px;
}
.empty-icon { font-size: 36px; margin-bottom: 12px; }
.error-bar {
  background: rgba(239,68,68,.1);
  border: 1px solid rgba(239,68,68,.3);
  border-radius: 8px; padding: 12px 16px;
  color: var(--danger); font-size: 13px;
  font-family: var(--font-mono); margin-bottom: 16px;
  display: none;
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1200px) {
  .charts-grid { grid-template-columns: 1fr 1fr; }
  .stats-grid  { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 768px) {
  main { padding: 16px; }
  header { padding: 0 16px; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .charts-grid { grid-template-columns: 1fr; }
  .filter-bar { flex-direction: column; }
  .modal { width: 95vw; }
}

/* â”€â”€â”€ APP LAYOUT WITH SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-body {
  display: flex;
  min-height: calc(100vh - 60px);
  position: relative;
}
.main-content {
  flex: 1;
  min-width: 0;
  padding: 24px 32px;
  transition: margin-right .35s cubic-bezier(.4,0,.2,1);
}
.main-content.sidebar-open {
  margin-right: 360px;
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  position: fixed;
  top: 60px; right: -360px;
  width: 360px;
  height: calc(100vh - 60px);
  background: var(--bg2);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  transition: right .35s cubic-bezier(.4,0,.2,1);
  z-index: 90;
  box-shadow: -8px 0 30px rgba(0,0,0,.4);
}
.sidebar.open { right: 0; }

/* Toggle button */
.sidebar-toggle {
  position: fixed;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  z-index: 95;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-right: none;
  border-radius: 8px 0 0 8px;
  padding: 14px 8px;
  cursor: pointer;
  display: flex; flex-direction: column;
  align-items: center; gap: 6px;
  transition: all .2s;
  writing-mode: vertical-rl;
}
.sidebar-toggle:hover {
  background: var(--bg);
  border-color: var(--accent);
}
.sidebar-toggle .toggle-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--accent);
  letter-spacing: .1em;
  text-transform: uppercase;
  writing-mode: vertical-rl;
  white-space: nowrap;
}
.sidebar-toggle .toggle-icon {
  font-size: 14px;
  color: var(--accent);
  transition: transform .3s;
}
.sidebar.open ~ .sidebar-toggle .toggle-icon { transform: rotate(180deg); }
.sidebar.open ~ .sidebar-toggle { right: 360px; }

/* Sidebar header */
.sidebar-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}
.sidebar-header-title {
  font-family: var(--font-mono);
  font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: .1em;
  flex: 1;
}
.sidebar-close {
  background: transparent; border: none;
  color: var(--muted); cursor: pointer;
  font-size: 16px; line-height: 1;
  transition: color .2s; padding: 2px;
}
.sidebar-close:hover { color: var(--danger); }

/* Sidebar body */
.sidebar-body {
  flex: 1; overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.sidebar-body::-webkit-scrollbar { width: 4px; }
.sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* Sidebar section */
.sb-section {
  border-bottom: 1px solid var(--border);
}
.sb-section-header {
  padding: 14px 20px;
  display: flex; align-items: center; gap: 10px;
  cursor: pointer;
  transition: background .15s;
  user-select: none;
}
.sb-section-header:hover { background: rgba(0,212,255,.04); }
.sb-section-icon {
  width: 28px; height: 28px;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; flex-shrink: 0;
}
.sb-section-icon.info  { background: rgba(0,212,255,.12); }
.sb-section-icon.alert { background: rgba(239,68,68,.12);  }
.sb-section-title {
  flex: 1;
  font-size: 12px; font-weight: 600;
  line-height: 1.3;
}
.sb-section-count {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 700;
}
.sb-section-count.info  { background: rgba(0,212,255,.15);  color: var(--accent); }
.sb-section-count.alert { background: rgba(239,68,68,.15);  color: var(--danger); }
.sb-chevron {
  color: var(--muted); font-size: 12px;
  transition: transform .25s;
}
.sb-section.collapsed .sb-chevron { transform: rotate(-90deg); }
.sb-section-body {
  overflow: hidden;
  transition: max-height .3s ease;
}
.sb-section.collapsed .sb-section-body { max-height: 0 !important; }

/* â”€â”€ Section 1: ThÃ´ng tin thiáº¿t bá»‹ â”€â”€ */
.sb-device-empty {
  padding: 30px 20px;
  text-align: center;
  color: var(--muted);
  font-size: 12px;
  font-family: var(--font-mono);
  line-height: 1.8;
}
.sb-device-empty .sb-empty-icon { font-size: 28px; margin-bottom: 10px; }
.sb-device-card {
  padding: 16px 20px;
}
.sb-device-name {
  font-size: 14px; font-weight: 700;
  margin-bottom: 4px; color: var(--text);
  line-height: 1.3;
}
.sb-device-tram {
  display: inline-flex; align-items: center; gap: 6px;
  margin-bottom: 14px;
}
.sb-device-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 14px;
}
.sb-field label {
  display: block;
  font-size: 9px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
  margin-bottom: 3px;
}
.sb-field value {
  display: block;
  font-size: 13px; font-weight: 600;
  font-family: var(--font-mono);
  color: var(--text);
}
.sb-text-block {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 11px;
  color: var(--muted);
  line-height: 1.7;
  white-space: pre-wrap;
  max-height: 120px;
  overflow-y: auto;
  margin-bottom: 8px;
}
.sb-text-label {
  font-size: 9px; color: var(--muted);
  font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .1em;
  margin-bottom: 4px;
}
.sb-divider {
  height: 1px; background: var(--border);
  margin: 12px 0;
}
.sb-badge-cap {
  display: inline-block;
  padding: 2px 8px; border-radius: 20px;
  font-size: 11px; font-family: var(--font-mono); font-weight: 700;
}

/* â”€â”€ Section 2: Báº¥t thÆ°á»ng â”€â”€ */
.sb-alert-list { padding: 0 0 8px; }
.sb-alert-item {
  padding: 12px 20px;
  border-bottom: 1px solid rgba(30,58,95,.4);
  transition: background .15s;
  cursor: pointer;
}
.sb-alert-item:hover { background: rgba(239,68,68,.04); }
.sb-alert-item:last-child { border-bottom: none; }
.sb-alert-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 5px;
}
.sb-alert-dot {
  width: 6px; height: 6px;
  background: var(--danger); border-radius: 50%;
  flex-shrink: 0;
  box-shadow: 0 0 6px var(--danger);
  animation: pulse 2s infinite;
}
.sb-alert-name {
  font-size: 12px; font-weight: 600;
  flex: 1; line-height: 1.3;
}
.sb-alert-tram {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 1px 6px; border-radius: 10px;
  background: rgba(0,212,255,.1); color: var(--accent);
}
.sb-alert-text {
  font-size: 11px; color: var(--muted);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  padding-left: 14px;
}
.sb-alert-empty {
  padding: 30px 20px;
  text-align: center;
  color: var(--accent3);
  font-size: 12px;
  font-family: var(--font-mono);
}
.sb-alert-more {
  padding: 10px 20px;
  text-align: center;
  font-size: 11px; color: var(--muted);
  font-family: var(--font-mono);
  cursor: pointer;
  border-top: 1px solid var(--border);
  transition: color .2s;
}
.sb-alert-more:hover { color: var(--accent); }

/* â”€â”€ Section link style â”€â”€ */
.sb-section-link {
  cursor: pointer;
  transition: background .15s;
}
.sb-section-link:hover {
  background: rgba(239,68,68,.04);
}
.sb-section-link .sb-section-header {
  cursor: pointer;
}
.sb-link-arrow {
  font-size: 16px;
  color: var(--danger);
  font-weight: 700;
  transition: transform .2s;
  margin-right: 2px;
}
.sb-section-link:hover .sb-link-arrow {
  transform: translate(2px,-2px);
}
.sb-section-preview {
  padding: 0 20px 14px;
}
.sb-preview-loading {
  font-size: 11px;
  color: var(--muted);
  font-family: var(--font-mono);
  padding: 6px 0;
}
.sb-preview-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 7px 0;
  border-bottom: 1px solid rgba(30,58,95,.4);
}
.sb-preview-item:last-child { border-bottom: none; }
.sb-preview-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 5px;
}
.sb-preview-dot.chua { background: var(--danger); box-shadow: 0 0 5px var(--danger); animation: pulse 1.5s infinite; }
.sb-preview-dot.da   { background: var(--accent3); }
.sb-preview-text {
  flex: 1;
  font-size: 11px;
  color: var(--muted);
  line-height: 1.4;
}
.sb-preview-text strong {
  display: block;
  color: var(--text);
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sb-preview-cta {
  margin-top: 10px;
  padding: 8px 14px;
  background: rgba(239,68,68,.1);
  border: 1px solid rgba(239,68,68,.25);
  border-radius: 6px;
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--danger);
  text-align: center;
  font-weight: 600;
  letter-spacing: .05em;
  transition: all .2s;
}
.sb-section-link:hover .sb-preview-cta {
  background: rgba(239,68,68,.18);
}

/* â”€â”€ Sidebar footer â”€â”€ */
.sidebar-footer {
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  display: flex; gap: 8px; flex-shrink: 0;
}
.sb-footer-btn {
  flex: 1; padding: 8px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: 6px; cursor: pointer;
  font-size: 11px; font-family: var(--font-mono);
  transition: all .2s;
  text-align: center;
}
.sb-footer-btn:hover { border-color: var(--accent); color: var(--accent); }
.sb-footer-btn.active { background: rgba(0,212,255,.1); border-color: var(--accent); color: var(--accent); }

@media (max-width: 768px) {
  .sidebar { width: 100vw; right: -100vw; }
  .sidebar.open { right: 0; }
  .main-content.sidebar-open { margin-right: 0; }
  .sidebar-toggle { display: none; }
}


/* â”€â”€ Sidebar báº¥t thÆ°á»ng: tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bt-tabs {
  display: flex; gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
}
.bt-tab {
  flex: 1; background: transparent; border: none;
  padding: 8px 4px; font-size: 10px; color: var(--muted);
  font-family: var(--font-mono); cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all .2s; letter-spacing: .03em;
}
.bt-tab:hover { color: var(--text); }
.bt-tab.active { color: var(--danger); border-bottom-color: var(--danger); background: rgba(239,68,68,.05); }
.bt-panel { max-height: 260px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.bt-item {
  padding: 9px 20px; border-bottom: 1px solid rgba(30,58,95,.3);
  cursor: pointer; transition: background .12s;
}
.bt-item:hover { background: rgba(239,68,68,.04); }
.bt-item:last-child { border-bottom: none; }
.bt-item-hd { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.bt-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.bt-dot.chua { background: var(--danger); box-shadow: 0 0 5px var(--danger); animation: pulse 1.5s infinite; }
.bt-dot.da   { background: var(--accent3); }
.bt-tram { font-size: 11px; font-weight: 600; color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bt-time { font-family: var(--font-mono); font-size: 9px; color: var(--muted); white-space: nowrap; }
.bt-dien-bien { font-size: 10px; color: var(--muted); line-height: 1.4; padding-left: 11px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.bt-cta {
  padding: 10px 20px; text-align: center; font-size: 10px;
  color: var(--danger); font-family: var(--font-mono);
  cursor: pointer; border-top: 1px solid var(--border);
  background: rgba(239,68,68,.04); transition: all .2s;
  letter-spacing: .05em; font-weight: 600;
}
.bt-cta:hover { background: rgba(239,68,68,.1); }

/* â”€â”€ Iframe panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.iframe-panel {
  position: fixed; top: 60px; left: 0; right: 0; bottom: 0;
  background: var(--bg); z-index: 200;
  display: none; flex-direction: column;
}
.iframe-panel.open { display: flex; }
.iframe-topbar {
  background: var(--bg2); border-bottom: 1px solid var(--border);
  padding: 10px 20px; display: flex; align-items: center; gap: 14px;
  flex-shrink: 0; height: 48px;
}
.iframe-topbar-title { font-family: var(--font-mono); font-size: 12px; color: var(--accent); flex: 1; }
.iframe-close-btn {
  background: transparent; border: 1px solid var(--border);
  color: var(--muted); padding: 4px 14px; border-radius: 4px;
  cursor: pointer; font-size: 11px; font-family: var(--font-mono);
  transition: all .2s;
}
.iframe-close-btn:hover { border-color: var(--danger); color: var(--danger); }
#bt-iframe { flex: 1; border: none; width: 100%; }

</style>
</head>
<body>

<!-- â•â• CONFIG OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="config-overlay">
  <div class="config-box">
    <h2>âš¡ TBA Dashboard â€“ Cáº¥u hÃ¬nh káº¿t ná»‘i</h2>
    <p>Nháº­p thÃ´ng tin Supabase Project cá»§a báº¡n Ä‘á»ƒ báº¯t Ä‘áº§u.</p>
    <div class="hint">
      ğŸ“ Láº¥y táº¡i: Supabase â†’ Settings â†’ API<br>
      URL dáº¡ng: <strong>https://xxxx.supabase.co</strong><br>
      Key: dÃ¹ng <strong>anon / public</strong> key
    </div>
    <div id="config-error" class="error-bar"></div>
    <label>Project URL</label>
    <input id="inp-url" type="text" placeholder="https://abcdefghij.supabase.co" spellcheck="false"/>
    <label>Anon Key (public)</label>
    <input id="inp-key" type="password" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." spellcheck="false"/>
    <button class="btn-primary" onclick="initDashboard()">ğŸ”Œ Káº¿t ná»‘i & Táº£i Dashboard</button>
    <div style="margin-top:16px;padding:12px 14px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:6px;font-size:11px;color:#f59e0b;font-family:'IBM Plex Mono',monospace;line-height:1.8">
      âš  Náº¿u lá»—i "permission denied" hoáº·c "RLS":<br>
      Supabase â†’ Table Editor â†’ thiet_bi<br>
      â†’ RLS â†’ <strong>Add Policy â†’ Enable read access for all users</strong><br>
      Hoáº·c SQL Editor cháº¡y:<br>
      <span style="color:#e2e8f0">CREATE POLICY "read_all" ON thiet_bi FOR SELECT USING (true);</span>
    </div>
  </div>
</div>

<!-- â•â• MODAL CHI TIáº¾T â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-box">
    <div class="modal-header">
      <h3 id="modal-title">Chi tiáº¿t thiáº¿t bá»‹</h3>
      <button class="btn-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo-mark">TBA</div>
  <div class="logo-text">Dashboard <span>110kV</span></div>
  <div class="header-meta">
    <div class="status-dot"></div>
    <span id="last-updated">â€”</span>
    <span id="header-db" style="color:var(--accent);font-size:11px;"></span>
    <button class="btn-config" onclick="document.getElementById('config-overlay').style.display='flex'">âš™ Cáº¥u hÃ¬nh</button>
  </div>
</header>

<!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-body">

<!-- â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sidebar" id="sidebar">

  <!-- Header -->
  <div class="sidebar-header">
    <div class="sidebar-header-title">âš¡ Báº£ng thÃ´ng tin nhanh</div>
    <button class="sidebar-close" onclick="toggleSidebar()">âœ•</button>
  </div>

  <!-- Body -->
  <div class="sidebar-body">

    <!-- â”€â”€ SECTION 1: ThÃ´ng tin thiáº¿t bá»‹ TBA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="sb-section" id="sb-sec-info">
      <div class="sb-section-header" onclick="toggleSection('sb-sec-info')">
        <div class="sb-section-icon info">ğŸ”§</div>
        <div class="sb-section-title">ThÃ´ng tin<br>thiáº¿t bá»‹ TBA</div>
        <span class="sb-section-count info" id="sb-info-count">â€”</span>
        <span class="sb-chevron">â–¼</span>
      </div>
      <div class="sb-section-body" id="sb-info-body">
        <div class="sb-device-empty" id="sb-info-empty">
          <div class="sb-empty-icon">ğŸ”Œ</div>
          Nháº¥n <strong>Chi tiáº¿t</strong> á»Ÿ báº£ng<br>Ä‘á»ƒ xem thÃ´ng tin thiáº¿t bá»‹
        </div>
        <div class="sb-device-card" id="sb-info-card" style="display:none"></div>
      </div>
    </div>

    <!-- â”€â”€ SECTION 2: Báº¥t thÆ°á»ng váº­n hÃ nh â€“ 2 tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="sb-section" id="sb-sec-alert">
      <div class="sb-section-header" onclick="toggleSection('sb-sec-alert')">
        <div class="sb-section-icon alert">âš </div>
        <div class="sb-section-title">Báº¥t thÆ°á»ng<br>váº­n hÃ nh</div>
        <span class="sb-section-count alert" id="sb-alert-count">â€”</span>
        <span class="sb-chevron">â–¼</span>
      </div>
      <div class="sb-section-body" id="sb-alert-body">

        <!-- Tab switcher -->
        <div class="bt-tabs">
          <button class="bt-tab active" id="tab-today" onclick="switchBtTab('today')">ğŸ“… HÃ´m nay</button>
          <button class="bt-tab"        id="tab-chua"  onclick="switchBtTab('chua')">âš  ChÆ°a xá»­ lÃ½</button>
        </div>

        <!-- Tab: hÃ´m nay -->
        <div id="bt-panel-today" class="bt-panel">
          <div class="sb-alert-empty" id="bt-today-empty">Äang táº£i...</div>
          <div id="bt-today-list"></div>
        </div>

        <!-- Tab: chÆ°a xá»­ lÃ½ -->
        <div id="bt-panel-chua" class="bt-panel" style="display:none">
          <div class="sb-alert-empty" id="bt-chua-empty" style="display:none"></div>
          <div id="bt-chua-list"></div>
        </div>

        <!-- CTA má»Ÿ trang Ä‘áº§y Ä‘á»§ -->
        <div class="bt-cta" onclick="openAlertPage()">
          Xem toÃ n bá»™ bÃ¡o cÃ¡o báº¥t thÆ°á»ng â†—
        </div>
      </div>
    </div>

  </div><!-- /sidebar-body -->

  <!-- Footer -->
  <div class="sidebar-footer">
    <button class="sb-footer-btn active" onclick="openAlertPanel()">âš  Xem bÃ¡o cÃ¡o Ä‘áº§y Ä‘á»§</button>
    <button class="sb-footer-btn" onclick="loadBatThuongSidebar()">â†º LÃ m má»›i</button>
  </div>
</div><!-- /sidebar -->

<!-- Toggle button -->
<button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Má»Ÿ/Ä‘Ã³ng báº£ng thÃ´ng tin">
  <span class="toggle-icon">â—€</span>
  <span class="toggle-label">Báº£ng thÃ´ng tin</span>
</button>

<main class="main-content" id="main-content">

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="stat-label">Tá»•ng tráº¡m</div>
      <div class="stat-value" id="s-trams">â€”</div>
      <div class="stat-sub">TBA trong há»‡ thá»‘ng</div>
    </div>
    <div class="stat-card amber">
      <div class="stat-label">Tá»•ng thiáº¿t bá»‹</div>
      <div class="stat-value" id="s-total">â€”</div>
      <div class="stat-sub">Báº£n ghi trong CSDL</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">CÃ³ Ä‘á» xuáº¥t SCL</div>
      <div class="stat-value" id="s-dexuat">â€”</div>
      <div class="stat-sub">Cáº§n sá»­a chá»¯a / lá»›n</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">TrÆ°á»›c nÄƒm 2000</div>
      <div class="stat-value" id="s-old">â€”</div>
      <div class="stat-sub">Thiáº¿t bá»‹ váº­n hÃ nh lÃ¢u</div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">

    <!-- HÃ€NG 1: Dropdown filters -->
    <div class="filter-row">
      <div class="filter-group">
        <label>ğŸ­ Tráº¡m biáº¿n Ã¡p</label>
        <select id="f-tram"><option value="">â€” Táº¥t cáº£ â€”</option></select>
      </div>
      <div class="filter-group">
        <label>âš¡ Cáº¥p Ä‘iá»‡n Ã¡p</label>
        <select id="f-cap"><option value="">â€” Táº¥t cáº£ â€”</option></select>
      </div>
      <div class="filter-group" style="flex:2;min-width:200px">
        <label>ğŸ”§ HÃ£ng sáº£n xuáº¥t</label>
        <select id="f-hang"><option value="">â€” Táº¥t cáº£ â€”</option></select>
      </div>
      <div class="filter-group">
        <label>ğŸ“¦ Loáº¡i thiáº¿t bá»‹</label>
        <!-- ÄÆ°á»£c build Ä‘á»™ng tá»« cá»™t tram_id (dá»¯ liá»‡u áº©n) trong buildFilterOptions() -->
        <select id="f-loai">
          <option value="">â€” Táº¥t cáº£ â€”</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ğŸ“… NÄƒm SX â€” <span style="color:var(--accent3)">Tá»« nÄƒm â‰¥</span></label>
        <select id="f-nam-from"><option value="">â€” Táº¥t cáº£ â€”</option></select>
      </div>
      <div class="filter-group">
        <label>ğŸ“… NÄƒm SX â€” <span style="color:var(--accent2)">Äáº¿n nÄƒm â‰¤</span></label>
        <select id="f-nam-to"><option value="">â€” Táº¥t cáº£ â€”</option></select>
      </div>
    </div>

    <!-- HÃ€NG 2: TÃ¬m kiáº¿m + preset + actions -->
    <div class="filter-row" style="align-items:flex-end;flex-wrap:wrap">
      <div class="filter-group" style="flex:1;min-width:260px">
        <label>ğŸ” TÃ¬m kiáº¿m tÃªn thiáº¿t bá»‹ / chá»§ng loáº¡i</label>
        <input id="f-search" type="text" placeholder="Nháº­p tÃªn thiáº¿t bá»‹, chá»§ng loáº¡i..." autocomplete="off"/>
      </div>
      <div class="filter-group">
        <label style="color:var(--muted)">ğŸ“‹ Äá» xuáº¥t SCL</label>
        <select id="f-dexuat">
          <option value="">â€” Táº¥t cáº£ â€”</option>
          <option value="co">CÃ³ Ä‘á» xuáº¥t</option>
          <option value="khong">ChÆ°a cÃ³ Ä‘á» xuáº¥t</option>
        </select>
      </div>
      <div class="filter-group">
        <label style="color:var(--muted)">âš¡ Lá»c nhanh nÄƒm SX</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;padding-top:2px">
          <button class="btn-preset" onclick="setPreset('','1999')">â‰¤&nbsp;1999</button>
          <button class="btn-preset" onclick="setPreset('2000','2009')">2000â€“09</button>
          <button class="btn-preset" onclick="setPreset('2010','2019')">2010â€“19</button>
          <button class="btn-preset" onclick="setPreset('2020','')">â‰¥&nbsp;2020</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;padding-bottom:1px">
        <button class="btn-filter" onclick="applyFilters()">ğŸ” Lá»c</button>
        <button class="btn-reset"  onclick="resetFilters()">âœ• XÃ³a</button>
      </div>
      <div class="filter-count">Káº¿t quáº£: <span id="count-display">â€”</span> thiáº¿t bá»‹</div>
    </div>

  </div>

    <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Thiáº¿t bá»‹ theo HÃ£ng sáº£n xuáº¥t</div>
      <div class="chart-wrap"><canvas id="chart-hang"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">PhÃ¢n bá»‘ NÄƒm sáº£n xuáº¥t</div>
      <div class="chart-wrap"><canvas id="chart-nam"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Thiáº¿t bá»‹ theo Cáº¥p Ä‘iá»‡n Ã¡p</div>
      <div class="chart-wrap"><canvas id="chart-cap"></canvas></div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-header">
      <div class="table-title">Danh sÃ¡ch thiáº¿t bá»‹</div>
      <button class="btn-export" onclick="exportCSV()">â¬‡ Xuáº¥t CSV</button>
    </div>
    <div id="error-bar" class="error-bar" style="margin:12px 16px;display:none;"></div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('stt')">STT</th>
            <th onclick="sortBy('ma_tram')">Tráº¡m</th>
            <th onclick="sortBy('ten_thiet_bi')">TÃªn thiáº¿t bá»‹</th>
            <th onclick="sortBy('cap_dien_ap')">Cáº¥p ÄA</th>
            <th onclick="sortBy('so_luong')">SL</th>
            <th onclick="sortBy('chung_loai')">Chá»§ng loáº¡i</th>
            <th onclick="sortBy('hang_san_xuat')">HÃ£ng SX</th>
            <th onclick="sortBy('nam_san_xuat')">NÄƒm SX</th>
            <th onclick="sortBy('nam_van_hanh')">NÄƒm VH</th>
            <th>Äá» xuáº¥t</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="11">
            <div class="loading">
              <div class="loading-spinner"></div>
              Äang káº¿t ná»‘i Supabase...
            </div>
          </td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

</main>

<!-- â•â• IFRAME PANEL: Báº¥t thÆ°á»ng váº­n hÃ nh â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="iframe-panel" id="iframe-panel">
  <div class="iframe-topbar">
    <div class="iframe-topbar-title">âš  BÃ¡o cÃ¡o Báº¥t thÆ°á»ng váº­n hÃ nh TBA 110kV</div>
    <button class="iframe-close-btn" onclick="closeAlertPanel()">âœ• ÄÃ³ng</button>
  </div>
  <iframe id="bt-iframe" src="" title="Báº¥t thÆ°á»ng váº­n hÃ nh"></iframe>
</div>

</div><!-- /app-body -->

<!-- â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let supabaseClient = null;
let allData        = [];   // ToÃ n bá»™ data Ä‘Ã£ fetch
let filteredData   = [];   // Sau khi lá»c
let currentPage    = 1;
const PAGE_SIZE    = 50;
let sortCol        = 'ma_tram';
let sortAsc        = true;
let charts         = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KHá»I Äá»˜NG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HÃ m Ä‘á»c message tá»« má»i kiá»ƒu error (Supabase, JS, string)
function parseError(e) {
  if (!e) return 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
  if (typeof e === 'string') return e;
  // Supabase error object: { message, code, details, hint }
  if (e.message) return e.message;
  if (e.error_description) return e.error_description;
  if (e.error) return String(e.error);
  // Fallback: stringify nhÆ°ng chá»‰ láº¥y message náº¿u cÃ³
  try { const j = JSON.parse(JSON.stringify(e)); return j.message || JSON.stringify(j); }
  catch { return String(e); }
}

async function initDashboard() {
  const url   = document.getElementById('inp-url').value.trim().replace(/\/$/, '');
  const key   = document.getElementById('inp-key').value.trim();
  const errEl = document.getElementById('config-error');
  const btn   = document.querySelector('#config-overlay .btn-primary');
  errEl.style.display = 'none';

  // â”€â”€ Validate input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!url || !key) {
    errEl.textContent = 'âš  Vui lÃ²ng nháº­p Ä‘á»§ URL vÃ  Anon Key!';
    errEl.style.display = 'block'; return;
  }
  if (!url.startsWith('https://')) {
    errEl.textContent = 'âš  URL pháº£i báº¯t Ä‘áº§u báº±ng https://  (vÃ­ dá»¥: https://xxxx.supabase.co)';
    errEl.style.display = 'block'; return;
  }
  if (!url.includes('.supabase.co')) {
    errEl.textContent = 'âš  URL pháº£i cÃ³ dáº¡ng https://xxxx.supabase.co';
    errEl.style.display = 'block'; return;
  }
  if (!key.startsWith('eyJ')) {
    errEl.textContent = 'âš  Anon Key khÃ´ng há»£p lá»‡ â€“ pháº£i báº¯t Ä‘áº§u báº±ng "eyJ..."';
    errEl.style.display = 'block'; return;
  }

  // â”€â”€ Táº¡o Supabase client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  btn.textContent = 'â³ Äang káº¿t ná»‘i...';
  btn.disabled    = true;

  try {
    // Kiá»ƒm tra library Ä‘Ã£ load chÆ°a
    if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
      throw new Error('ThÆ° viá»‡n Supabase chÆ°a load â€“ hÃ£y kiá»ƒm tra káº¿t ná»‘i Internet');
    }

    supabaseClient = supabase.createClient(url, key, {
      auth: { persistSession: false }
    });

    // â”€â”€ Test káº¿t ná»‘i: láº¥y thá»­ 1 row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // KhÃ´ng dÃ¹ng head:true vÃ¬ má»™t sá»‘ RLS config cháº·n COUNT
    const { data, error } = await supabaseClient
      .from('thiet_bi')
      .select('id, ma_tram')
      .limit(1);

    if (error) {
      // PhÃ¢n loáº¡i lá»—i Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o há»¯u Ã­ch
      const code = error.code || '';
      const msg  = error.message || '';

      if (code === 'PGRST116' || msg.includes('does not exist')) {
        throw new Error('Báº£ng "thiet_bi" chÆ°a tá»“n táº¡i trong Supabase. HÃ£y cháº¡y láº¡i script SQL táº¡o báº£ng.');
      }
      if (code === '42501' || msg.includes('permission') || msg.includes('policy')) {
        throw new Error('RLS cháº·n truy cáº­p. HÃ£y vÃ o Supabase â†’ Authentication â†’ Policies â†’ thÃªm policy SELECT cho báº£ng thiet_bi.');
      }
      if (msg.includes('Invalid API key') || msg.includes('JWT')) {
        throw new Error('Anon Key khÃ´ng Ä‘Ãºng hoáº·c Ä‘Ã£ háº¿t háº¡n. HÃ£y copy láº¡i tá»« Supabase â†’ Settings â†’ API.');
      }
      throw new Error(msg || JSON.stringify(error));
    }

    // â”€â”€ Káº¿t ná»‘i thÃ nh cÃ´ng â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    localStorage.setItem('tba_url', url);
    localStorage.setItem('tba_key', key);
    document.getElementById('config-overlay').style.display = 'none';
    document.getElementById('header-db').textContent =
      new URL(url).hostname.split('.')[0];

    await loadAllData();

  } catch(e) {
    errEl.textContent = 'âŒ ' + parseError(e);
    errEl.style.display = 'block';
  } finally {
    btn.textContent = 'ğŸ”Œ Káº¿t ná»‘i & Táº£i Dashboard';
    btn.disabled    = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD Dá»® LIá»†U Tá»ª SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllData() {
  showTableLoading();
  try {
    // Láº¥y toÃ n bá»™ data (phÃ¢n trang Supabase 1000/láº§n)
    let all = [], from = 0, chunk;
    do {
      const { data, error } = await supabaseClient
        .from('thiet_bi')
        .select('*')
        .order('ma_tram', { ascending: true })
        .order('stt', { ascending: true })
        .range(from, from + 999);
      if (error) throw new Error(error.message || JSON.stringify(error));
      chunk = data || [];
      all = all.concat(chunk);
      from += 1000;
    } while (chunk.length === 1000);

    allData = all;

    // Má»—i bÆ°á»›c bá»c try-catch riÃªng Ä‘á»ƒ lá»—i chart/stat khÃ´ng xÃ³a báº£ng
    try { buildFilterOptions(allData); } catch(fe){ console.warn('buildFilterOptions:', fe); }
    try { applyFilters(); }             catch(fe){ console.warn('applyFilters:', fe); }
    try { updateStats(allData); }       catch(fe){ console.warn('updateStats:', fe); }
    try { drawCharts(allData); }        catch(fe){ console.warn('drawCharts:', fe); }

    try {
      const now = new Date();
      const upEl = document.getElementById('last-updated');
      if (upEl) upEl.textContent = 'Cáº­p nháº­t: ' + now.toLocaleTimeString('vi-VN');
    } catch(fe){}

    // Cáº­p nháº­t sidebar báº¥t thÆ°á»ng (load riÃªng tá»« Supabase)
    loadBatThuongSidebar().catch(e => console.warn('Sidebar bt error:', e));

  } catch(e) {
    showError('Lá»—i táº£i dá»¯ liá»‡u: ' + parseError(e));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD FILTER OPTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilterOptions(data) {
  // â”€â”€ Tráº¡m biáº¿n Ã¡p â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const trams = [...new Set(data.map(r => r.ma_tram).filter(Boolean))].sort();
  const tramSel = document.getElementById('f-tram');
  tramSel.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
    trams.map(t => `<option value="${t}">${t}</option>`).join('');

  // â”€â”€ Cáº¥p Ä‘iá»‡n Ã¡p â€” láº¥y tá»« data thá»±c, sort sá»‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const caps = [...new Set(data.map(r => r.cap_dien_ap).filter(v => v !== null && v !== undefined))]
    .sort((a,b) => a-b);
  const capSel = document.getElementById('f-cap');
  capSel.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
    caps.map(c => `<option value="${c}">${c} kV</option>`).join('');

  // â”€â”€ HÃ£ng sáº£n xuáº¥t â€” LÃ€M Sáº CH dá»¯ liá»‡u báº©n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Chá»‰ láº¥y giÃ¡ trá»‹ Há»¢P Lá»†:
  //   - KhÃ´ng pháº£i sá»‘ nguyÃªn (nÄƒm bá»‹ lá»‡ch cá»™t)
  //   - KhÃ´ng pháº£i ngÃ y thÃ¡ng "dd/mm/yyyy"
  //   - KhÃ´ng dÃ i hÆ¡n 100 kÃ½ tá»± (ghi chÃº bá»‹ lá»‡ch cá»™t)
  //   - KhÃ´ng chá»©a toÃ n sá»‘
  function isValidHang(v) {
    if (!v) return false;
    const s = String(v).trim();
    if (s.length === 0 || s.length > 100) return false;       // QuÃ¡ ngáº¯n/dÃ i
    if (/^\d{4}$/.test(s)) return false;                       // Chá»‰ lÃ  nÄƒm: "2018"
    if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) return false;     // NgÃ y: "16/08/2016"
    if (/^\d{1,2}\/\d{4}$/.test(s)) return false;             // ThÃ¡ng/nÄƒm: "11/2012"
    if (/^\d+$/.test(s)) return false;                         // ToÃ n sá»‘
    if (s.includes('\n') || s.includes('Tá»§ phÃ¢n phá»‘i')) return false; // Ghi chÃº dÃ i
    return true;
  }

  const hangs = [...new Set(data.map(r => r.hang_san_xuat).filter(isValidHang))].sort();
  const hangSel = document.getElementById('f-hang');
  hangSel.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
    hangs.map(h => `<option value="${escHtml(h)}">${escHtml(h)}</option>`).join('');

  // â”€â”€ NÄƒm sáº£n xuáº¥t â€” tÄƒng dáº§n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const years = [...new Set(data.map(r => r.nam_san_xuat)
    .filter(v => v && Number.isInteger(v) && v > 1900 && v < 2100))]
    .sort((a,b) => a-b);

  const yFrom = document.getElementById('f-nam-from');
  const yTo   = document.getElementById('f-nam-to');

  yFrom.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
    years.map(y => `<option value="${y}">â‰¥ ${y}</option>`).join('');
  yTo.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
    years.map(y => `<option value="${y}">â‰¤ ${y}</option>`).join('');

  // â”€â”€ Loáº¡i thiáº¿t bá»‹ â€” build tá»« cá»™t tram_id (áº©n trong báº£ng) â”€â”€â”€â”€â”€â”€
  // tram_id chá»©a phÃ¢n loáº¡i thiáº¿t bá»‹, VD: "MÃ¡y biáº¿n Ã¡p", "MÃ¡y cáº¯t"...
  // Dá»¯ liá»‡u Ä‘Æ°á»£c fetch theo select('*') nhÆ°ng KHÃ”NG hiá»ƒn thá»‹ trong báº£ng
  const loaiSel = document.getElementById('f-loai');
  const loaiValues = [...new Set(
    data.map(r => (r.tram_id || '').trim()).filter(Boolean)
  )].sort((a, b) => a.localeCompare(b, 'vi'));

  if (loaiValues.length > 0) {
    // Giá»¯ láº¡i option Ä‘ang chá»n (náº¿u cÃ³) khi refresh data
    const currentVal = loaiSel.value;
    loaiSel.innerHTML = '<option value="">â€” Táº¥t cáº£ â€”</option>' +
      loaiValues.map(v => `<option value="${escHtml(v)}">${escHtml(v)}</option>`).join('');
    // KhÃ´i phá»¥c lá»±a chá»n cÅ© náº¿u váº«n cÃ²n trong list
    if (currentVal && loaiValues.includes(currentVal)) {
      loaiSel.value = currentVal;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lá»ŒC Dá»® LIá»†U
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilters() {
  const tram    = document.getElementById('f-tram').value;
  const cap     = document.getElementById('f-cap').value;
  const hang    = document.getElementById('f-hang').value;
  const namFrom = document.getElementById('f-nam-from').value;
  const namTo   = document.getElementById('f-nam-to').value;
  const search  = document.getElementById('f-search').value.trim().toLowerCase();

  // â”€â”€ Validate: tá»« nÄƒm khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n Ä‘áº¿n nÄƒm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const selFrom = document.getElementById('f-nam-from');
  const selTo   = document.getElementById('f-nam-to');
  if (namFrom && namTo && parseInt(namFrom) > parseInt(namTo)) {
    selFrom.style.borderColor = 'var(--danger)';
    selTo.style.borderColor   = 'var(--danger)';
    // HoÃ¡n Ä‘á»•i tá»± Ä‘á»™ng thay vÃ¬ bÃ¡o lá»—i
    const tmp = namFrom;
    document.getElementById('f-nam-from').value = namTo;
    document.getElementById('f-nam-to').value   = tmp;
    return applyFilters(); // Gá»i láº¡i sau khi Ä‘á»•i
  } else {
    selFrom.style.borderColor = '';
    selTo.style.borderColor   = '';
  }

  const nFrom = namFrom ? parseInt(namFrom) : null;
  const nTo   = namTo   ? parseInt(namTo)   : null;

  const loai   = document.getElementById('f-loai')?.value  || '';
  const dexuat = document.getElementById('f-dexuat')?.value || '';

  filteredData = allData.filter(r => {
    // Tráº¡m
    if (tram && r.ma_tram !== tram) return false;
    // Cáº¥p Ä‘iá»‡n Ã¡p
    if (cap  && String(r.cap_dien_ap) !== cap) return false;
    // HÃ£ng sáº£n xuáº¥t (exact match)
    if (hang && r.hang_san_xuat !== hang) return false;
    // Loáº¡i thiáº¿t bá»‹ â€” exact match theo cá»™t tram_id (áº©n, khÃ´ng hiá»‡n trong báº£ng)
    if (loai && (r.tram_id || '').trim() !== loai) return false;
    // NÄƒm SX tá»« (â‰¥)
    if (nFrom !== null && (r.nam_san_xuat === null || r.nam_san_xuat < nFrom)) return false;
    // NÄƒm SX Ä‘áº¿n (â‰¤)
    if (nTo   !== null && (r.nam_san_xuat === null || r.nam_san_xuat > nTo))   return false;
    // TÃ¬m kiáº¿m tÃªn TB / chá»§ng loáº¡i
    if (search && !(r.ten_thiet_bi||'').toLowerCase().includes(search) &&
                  !(r.chung_loai||'').toLowerCase().includes(search) &&
                  !(r.hang_san_xuat||'').toLowerCase().includes(search))       return false;
    // Äá» xuáº¥t SCL
    if (dexuat === 'co'    && !(r.de_xuat && r.de_xuat.trim())) return false;
    if (dexuat === 'khong' &&  (r.de_xuat && r.de_xuat.trim())) return false;
    return true;
  });

  // Sáº¯p xáº¿p
  filteredData.sort((a, b) => {
    const va = a[sortCol] ?? '';
    const vb = b[sortCol] ?? '';
    const cmp = va < vb ? -1 : va > vb ? 1 : 0;
    return sortAsc ? cmp : -cmp;
  });

  currentPage = 1;
  document.getElementById('count-display').textContent = filteredData.length.toLocaleString('vi-VN');

  // â”€â”€ Highlight nÃºt preset Ä‘ang active â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.btn-preset').forEach(b => b.classList.remove('active'));
  const presetKey = `${namFrom}|${namTo}`;
  const presetMap = { '|1999':'â‰¤ 1999', '2000|2009':'2000â€“09', '2010|2019':'2010â€“19', '2020|':'â‰¥ 2020' };
  if (presetMap[presetKey]) {
    document.querySelectorAll('.btn-preset').forEach(b => {
      if (b.textContent.trim() === presetMap[presetKey]) b.classList.add('active');
    });
  }

  renderTable();
}

function setPreset(from, to) {
  document.getElementById('f-nam-from').value = from;
  document.getElementById('f-nam-to').value   = to;
  applyFilters();
}

function resetFilters() {
  ['f-tram','f-cap','f-hang','f-loai','f-dexuat','f-nam-from','f-nam-to'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.value = ''; el.style.borderColor = ''; }
  });
  document.getElementById('f-search').value = '';
  document.querySelectorAll('.btn-preset').forEach(b => b.classList.remove('active'));
  applyFilters();
}

function sortBy(col) {
  if (sortCol === col) sortAsc = !sortAsc;
  else { sortCol = col; sortAsc = true; }
  // ÄÃ¡nh dáº¥u cá»™t Ä‘Æ°á»£c sort
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
  event.target.classList.add('sorted');
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const tbody = document.getElementById('table-body');
  if (!tbody) return;
  const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageData = filteredData.slice(start, start + PAGE_SIZE);

  if (pageData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="11">
      <div class="empty">
        <div class="empty-icon">ğŸ“­</div>
        KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u phÃ¹ há»£p
      </div>
    </td></tr>`;
  } else {
    tbody.innerHTML = pageData.map((r, idx) => {
      const capBadge = capBadgeClass(r.cap_dien_ap);
      const tenTb = escHtml(r.ten_thiet_bi || 'â€”');
      const hang  = escHtml(r.hang_san_xuat || 'â€”');
      const cl    = escHtml(r.chung_loai || 'â€”');
      const dexuat= r.de_xuat ? `<div class="text-clamp">${escHtml(r.de_xuat)}</div>` : '<span style="color:var(--muted)">â€”</span>';
      return `<tr>
        <td class="mono" style="color:var(--muted)">${start + idx + 1}</td>
        <td><span class="badge badge-tram">${escHtml(r.ma_tram||'?')}</span></td>
        <td style="font-weight:600;min-width:180px">${tenTb}</td>
        <td><span class="badge ${capBadge}">${r.cap_dien_ap ? r.cap_dien_ap+'kV' : 'â€”'}</span></td>
        <td class="mono" style="text-align:center">${r.so_luong ?? 'â€”'}</td>
        <td class="mono" style="font-size:11px;color:var(--muted)">${cl}</td>
        <td style="font-weight:600">${hang}</td>
        <td class="mono">${r.nam_san_xuat || 'â€”'}</td>
        <td class="mono" style="font-size:11px;color:var(--muted)">${formatNamVH(r.nam_van_hanh)}</td>
        <td style="max-width:220px">${dexuat}</td>
        <td><button class="btn-detail" onclick='showDetail(${JSON.stringify(JSON.stringify(r))})'>Chi tiáº¿t</button></td>
      </tr>`;
    }).join('');
  }

  renderPagination(totalPages);
}

function capBadgeClass(cap) {
  if (!cap) return 'badge-other';
  const c = parseFloat(cap);
  if (c >= 110) return 'badge-110';
  if (c >= 35)  return 'badge-35';
  if (c >= 22)  return 'badge-22';
  return 'badge-other';
}

function formatNamVH(v) {
  if (!v) return 'â€”';
  // Náº¿u YYYY-MM-DD â†’ hiá»ƒn thá»‹ MM/YYYY
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
    const [y, m] = v.split('-');
    return `${m}/${y}`;
  }
  return v;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGINATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPagination(total) {
  const el = document.getElementById('pagination');
  if (total <= 1) { el.innerHTML = ''; return; }

  let html = `<button onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>â—€</button>`;

  const range = pageRange(currentPage, total);
  range.forEach(p => {
    if (p === 'â€¦') html += `<button disabled>â€¦</button>`;
    else html += `<button class="${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</button>`;
  });

  html += `<button onclick="goPage(${currentPage+1})" ${currentPage===total?'disabled':''}>â–¶</button>`;
  html += `<span class="page-info">Trang ${currentPage}/${total} &nbsp;|&nbsp; ${filteredData.length.toLocaleString('vi-VN')} báº£n ghi</span>`;
  el.innerHTML = html;
}

function pageRange(cur, total) {
  if (total <= 7) return Array.from({length:total}, (_,i) => i+1);
  if (cur <= 4) return [1,2,3,4,5,'â€¦',total];
  if (cur >= total-3) return [1,'â€¦',total-4,total-3,total-2,total-1,total];
  return [1,'â€¦',cur-1,cur,cur+1,'â€¦',total];
}

function goPage(p) {
  const total = Math.ceil(filteredData.length / PAGE_SIZE);
  if (p < 1 || p > total) return;
  currentPage = p;
  renderTable();
  window.scrollTo({ top: document.querySelector('.table-card').offsetTop - 80, behavior: 'smooth' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats(data) {
  const trams  = new Set(data.map(r => r.ma_tram).filter(Boolean));
  const dexuat = data.filter(r => r.de_xuat && r.de_xuat.trim()).length;
  const old    = data.filter(r => r.nam_san_xuat && r.nam_san_xuat < 2000).length;

  animCount('s-trams', trams.size);
  animCount('s-total', data.length);
  animCount('s-dexuat', dexuat);
  animCount('s-old', old);
}

function animCount(id, target) {
  const el = document.getElementById(id);
  let cur = 0;
  const step = Math.ceil(target / 40);
  const timer = setInterval(() => {
    cur = Math.min(cur + step, target);
    el.textContent = cur.toLocaleString('vi-VN');
    if (cur >= target) clearInterval(timer);
  }, 30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHART_COLORS = [
  '#00d4ff','#f59e0b','#10b981','#ef4444','#8b5cf6',
  '#ec4899','#14b8a6','#f97316','#84cc16','#6366f1'
];

function drawCharts(data) {
  drawHangChart(data);
  drawNamChart(data);
  drawCapChart(data);
}

function drawHangChart(data) {
  const counts = {};
  data.forEach(r => {
    const h = r.hang_san_xuat || 'KhÃ´ng rÃµ';
    counts[h] = (counts[h] || 0) + 1;
  });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 8);

  if (charts.hang) charts.hang.destroy();
  charts.hang = new Chart(document.getElementById('chart-hang'), {
    type: 'bar',
    data: {
      labels: sorted.map(e => e[0]),
      datasets: [{ data: sorted.map(e => e[1]),
        backgroundColor: CHART_COLORS,
        borderRadius: 4, borderWidth: 0 }]
    },
    options: chartOpts('Sá»‘ thiáº¿t bá»‹')
  });
}

function drawNamChart(data) {
  const counts = {};
  data.filter(r => r.nam_san_xuat).forEach(r => {
    const decade = Math.floor(r.nam_san_xuat / 5) * 5;
    const label  = `${decade}â€“${decade+4}`;
    counts[label] = (counts[label] || 0) + 1;
  });
  const sorted = Object.entries(counts).sort((a,b) => a[0].localeCompare(b[0]));

  if (charts.nam) charts.nam.destroy();
  charts.nam = new Chart(document.getElementById('chart-nam'), {
    type: 'line',
    data: {
      labels: sorted.map(e => e[0]),
      datasets: [{ data: sorted.map(e => e[1]),
        borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,.1)',
        fill: true, tension: .4, pointRadius: 4,
        pointBackgroundColor: '#f59e0b' }]
    },
    options: chartOpts('Sá»‘ thiáº¿t bá»‹')
  });
}

function drawCapChart(data) {
  const counts = {};
  data.forEach(r => {
    const c = r.cap_dien_ap ? r.cap_dien_ap + ' kV' : 'KhÃ´ng rÃµ';
    counts[c] = (counts[c] || 0) + 1;
  });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);

  if (charts.cap) charts.cap.destroy();
  charts.cap = new Chart(document.getElementById('chart-cap'), {
    type: 'doughnut',
    data: {
      labels: sorted.map(e => e[0]),
      datasets: [{ data: sorted.map(e => e[1]),
        backgroundColor: CHART_COLORS,
        borderColor: '#111827', borderWidth: 2 }]
    },
    options: {
      ...chartOpts(), cutout: '65%',
      plugins: { legend: { display: true, position: 'right',
        labels: { color: '#64748b', font: { size: 11 }, boxWidth: 12, padding: 10 }}}
    }
  });
}

function chartOpts(yLabel) {
  return {
    responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1a2235',
        borderColor: '#1e3a5f', borderWidth: 1,
        titleColor: '#00d4ff', bodyColor: '#e2e8f0',
        padding: 10, cornerRadius: 6
      }
    },
    scales: yLabel ? {
      x: { ticks: { color: '#64748b', font:{size:10} }, grid: { display: false } },
      y: { ticks: { color: '#64748b', font:{size:10} },
           grid: { color: 'rgba(30,58,95,.5)' },
           title: { display: false }
      }
    } : undefined
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL CHI TIáº¾T
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(jsonStr) {
  const r = JSON.parse(jsonStr);
  const mt = document.getElementById('modal-title');
  if (mt) mt.textContent = `${r.ma_tram || ''} â€“ ${r.ten_thiet_bi || 'Chi tiáº¿t thiáº¿t bá»‹'}`;

  const field = (label, val, mono=false) =>
    `<div class="detail-field">
      <label>${label}</label>
      <value style="${mono?'font-family:var(--font-mono);font-size:13px':''}">${escHtml(String(val ?? 'â€”'))}</value>
    </div>`;

  const textBlock = (label, val) => val ?
    `<div class="detail-field full">
      <label>${label}</label>
      <div class="detail-text">${escHtml(val)}</div>
    </div>` : '';

  document.getElementById('modal-body').innerHTML = `
    <div class="detail-grid">
      ${field('Tráº¡m', r.ma_tram)}
      ${field('STT', r.stt, true)}
      ${field('TÃªn thiáº¿t bá»‹', r.ten_thiet_bi)}
      ${field('Cáº¥p Ä‘iá»‡n Ã¡p', r.cap_dien_ap ? r.cap_dien_ap + ' kV' : 'â€”')}
      ${field('Sá»‘ lÆ°á»£ng', r.so_luong, true)}
      ${field('Chá»§ng loáº¡i', r.chung_loai, true)}
      ${field('HÃ£ng sáº£n xuáº¥t', r.hang_san_xuat)}
      ${field('NÄƒm sáº£n xuáº¥t', r.nam_san_xuat, true)}
      ${field('NÄƒm váº­n hÃ nh', r.nam_van_hanh, true)}
    </div>
    ${textBlock('TÃ¬nh tráº¡ng váº­n hÃ nh / sá»­a chá»¯a gáº§n nháº¥t', r.tinh_trang_van_hanh)}
    ${textBlock('Äá» xuáº¥t', r.de_xuat)}
    ${textBlock('Ghi chÃº (CÃ´ng trÃ¬nh)', r.ghi_chu)}
  `;
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('modal-overlay'))
    document.getElementById('modal-overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!filteredData.length) return;
  const cols = ['ma_tram','stt','ten_thiet_bi','cap_dien_ap','so_luong',
                 'chung_loai','hang_san_xuat','nam_san_xuat','nam_van_hanh',
                 'tinh_trang_van_hanh','de_xuat','ghi_chu'];
  const header = ['Tráº¡m','STT','TÃªn thiáº¿t bá»‹','Cáº¥p ÄA(kV)','Sá»‘ lÆ°á»£ng',
                   'Chá»§ng loáº¡i','HÃ£ng SX','NÄƒm SX','NÄƒm VH',
                   'TÃ¬nh tráº¡ng','Äá» xuáº¥t','Ghi chÃº'];
  const rows = [header, ...filteredData.map(r =>
    cols.map(c => csvEsc(r[c]))
  )];
  const csv  = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `TBA_Export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(url);
}
function csvEsc(v) {
  if (v === null || v === undefined) return '';
  const s = String(v).replace(/"/g, '""');
  return s.includes(',') || s.includes('\n') || s.includes('"') ? `"${s}"` : s;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showTableLoading() {
  const tb = document.getElementById('table-body');
  if (tb) tb.innerHTML =
    `<tr><td colspan="11"><div class="loading"><div class="loading-spinner"></div>Äang táº£i dá»¯ liá»‡u...</div></td></tr>`;
}
function showError(msg) {
  const el = document.getElementById('error-bar');
  if (el) { el.textContent = 'âŒ ' + msg; el.style.display = 'block'; }
  const tb = document.getElementById('table-body');
  if (tb) tb.innerHTML =
    `<tr><td colspan="11"><div class="empty"><div class="empty-icon">âš ï¸</div>${escHtml(msg)}</div></td></tr>`;
}

// â”€â”€ Auto-load tá»« localStorage náº¿u Ä‘Ã£ cáº¥u hÃ¬nh trÆ°á»›c â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const url = localStorage.getItem('tba_url');
  const key = localStorage.getItem('tba_key');
  if (url && key) {
    document.getElementById('inp-url').value = url;
    document.getElementById('inp-key').value = key;
    initDashboard();
  }
});

// â”€â”€ Enter Ä‘á»ƒ káº¿t ná»‘i â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('config-overlay').style.display !== 'none')
    initDashboard();
  if (e.key === 'Enter' && document.activeElement.id === 'f-search')
    applyFilters();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sidebarOpen   = false;
let alertShowAll  = false;
const ALERT_LIMIT = 20;

function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('open', sidebarOpen);
  document.getElementById('main-content').classList.toggle('sidebar-open', sidebarOpen);
  const icon = document.querySelector('.toggle-icon');
  icon.textContent = sidebarOpen ? 'â–¶' : 'â—€';
}

function toggleSection(id) {
  document.getElementById(id).classList.toggle('collapsed');
  // Cáº­p nháº­t max-height cho animation mÆ°á»£t
  const body = document.getElementById(id).querySelector('.sb-section-body');
  if (document.getElementById(id).classList.contains('collapsed')) {
    body.style.maxHeight = '0';
  } else {
    body.style.maxHeight = body.scrollHeight + 'px';
  }
}

// â”€â”€ Section 1: Hiá»ƒn thá»‹ chi tiáº¿t thiáº¿t bá»‹ vÃ o sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetailAndSidebar(jsonStr) {
  const r = JSON.parse(jsonStr);
  showDeviceInSidebar(r);
  // Chá»‰ má»Ÿ modal khi sidebar chÆ°a open hoáº·c mÃ n nhá»
  if (window.innerWidth < 900 || !sidebarOpen) {
    // Gá»i modal trá»±c tiáº¿p khÃ´ng qua showDetail Ä‘Ã£ bá»‹ patch
    const mt2 = document.getElementById('modal-title');
    if (mt2) mt2.textContent = `${r.ma_tram || ''} â€“ ${r.ten_thiet_bi || 'Chi tiáº¿t thiáº¿t bá»‹'}`;
    const field = (label, val, mono=false) =>
      `<div class="detail-field">
        <label>${label}</label>
        <value style="${mono?'font-family:var(--font-mono);font-size:13px':''}">${escHtml(String(val ?? 'â€”'))}</value>
      </div>`;
    const textBlock = (label, val) => val ?
      `<div class="detail-field full"><label>${label}</label><div class="detail-text">${escHtml(val)}</div></div>` : '';
    document.getElementById('modal-body').innerHTML = `
      <div class="detail-grid">
        ${field('Tráº¡m', r.ma_tram)}
        ${field('STT', r.stt, true)}
        ${field('TÃªn thiáº¿t bá»‹', r.ten_thiet_bi)}
        ${field('Cáº¥p Ä‘iá»‡n Ã¡p', r.cap_dien_ap ? r.cap_dien_ap + ' kV' : 'â€”')}
        ${field('Sá»‘ lÆ°á»£ng', r.so_luong, true)}
        ${field('Chá»§ng loáº¡i', r.chung_loai, true)}
        ${field('HÃ£ng sáº£n xuáº¥t', r.hang_san_xuat)}
        ${field('NÄƒm sáº£n xuáº¥t', r.nam_san_xuat, true)}
        ${field('NÄƒm váº­n hÃ nh', r.nam_van_hanh, true)}
      </div>
      ${textBlock('TÃ¬nh tráº¡ng váº­n hÃ nh', r.tinh_trang_van_hanh)}
      ${textBlock('Äá» xuáº¥t', r.de_xuat)}
      ${textBlock('Ghi chÃº', r.ghi_chu)}
    `;
    document.getElementById('modal-overlay').classList.add('open');
  }
}

function showDeviceInSidebar(r) {
  // Má»Ÿ sidebar náº¿u chÆ°a má»Ÿ
  if (!sidebarOpen) toggleSidebar();

  // Má»Ÿ section 1 náº¿u Ä‘ang Ä‘Ã³ng
  const sec = document.getElementById('sb-sec-info');
  if (sec.classList.contains('collapsed')) toggleSection('sb-sec-info');

  document.getElementById('sb-info-empty').style.display = 'none';
  const card = document.getElementById('sb-info-card');
  card.style.display = 'block';

  // Badge cáº¥p Ä‘iá»‡n Ã¡p
  const capClass = r.cap_dien_ap >= 110 ? 'badge-110' :
                   r.cap_dien_ap >= 35  ? 'badge-35'  :
                   r.cap_dien_ap >= 22  ? 'badge-22'  : 'badge-other';

  const capStr = r.cap_dien_ap ? r.cap_dien_ap + ' kV' : 'â€”';

  card.innerHTML = `
    <div class="sb-device-name">${escHtml(r.ten_thiet_bi || 'â€”')}</div>
    <div class="sb-device-tram">
      <span class="badge badge-tram">${escHtml(r.ma_tram || '?')}</span>
      <span class="sb-badge-cap ${capClass}">${capStr}</span>
    </div>
    <div class="sb-device-grid">
      ${sbField('STT', r.stt)}
      ${sbField('Sá»‘ lÆ°á»£ng', r.so_luong)}
      ${sbField('HÃ£ng SX', r.hang_san_xuat)}
      ${sbField('Chá»§ng loáº¡i', r.chung_loai)}
      ${sbField('NÄƒm sáº£n xuáº¥t', r.nam_san_xuat)}
      ${sbField('NÄƒm váº­n hÃ nh', formatNamVH(r.nam_van_hanh))}
    </div>
    ${r.tinh_trang_van_hanh ? `
      <div class="sb-text-label">TÃ¬nh tráº¡ng váº­n hÃ nh</div>
      <div class="sb-text-block">${escHtml(r.tinh_trang_van_hanh)}</div>` : ''}
    ${r.de_xuat ? `
      <div class="sb-divider"></div>
      <div class="sb-text-label" style="color:var(--accent2)">âš¡ Äá» xuáº¥t SCL</div>
      <div class="sb-text-block" style="border-color:rgba(245,158,11,.3)">${escHtml(r.de_xuat)}</div>` : ''}
    ${r.ghi_chu ? `
      <div class="sb-text-label">Ghi chÃº</div>
      <div class="sb-text-block">${escHtml(r.ghi_chu)}</div>` : ''}
  `;

  document.getElementById('sb-info-count').textContent =
    r.ma_tram ? `#${r.stt} â€“ ${r.ma_tram}` : `#${r.stt}`;
}

function sbField(label, val) {
  return `<div class="sb-field">
    <label>${label}</label>
    <value>${escHtml(String(val ?? 'â€”'))}</value>
  </div>`;
}

// â”€â”€ Section 2: Render danh sÃ¡ch báº¥t thÆ°á»ng â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR Báº¤T THÆ¯á»œNG: Load tá»« Supabase báº£ng bat_thuong
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let btData = [];   // Dá»¯ liá»‡u báº£ng bat_thuong
let btTab  = 'today'; // Tab hiá»‡n táº¡i: 'today' | 'chua'

// KhÃ´ng cÃ²n sb-alert-list cÅ©
function renderAlertList(data) { /* Deprecated â€“ dÃ¹ng loadBatThuongSidebar() */ }
function refreshSidebar() { loadBatThuongSidebar(); }

// â”€â”€ Load dá»¯ liá»‡u bat_thuong tá»« Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBatThuongSidebar() {
  if (!supabaseClient) return;
  try {
    const { data, error } = await supabaseClient
      .from('bat_thuong')
      .select('stt,phan_loai,tram,tb_cha,dien_bien,tg_xuat_hien,trang_thai')
      .order('tg_xuat_hien', { ascending: false })
      .limit(200);
    if (error) throw error;
    btData = data || [];
    renderBtSidebar();
  } catch(e) {
    console.warn('loadBatThuongSidebar:', e);
    // KhÃ´ng cÃ³ báº£ng bat_thuong â†’ hiá»ƒn thá»‹ thÃ´ng bÃ¡o
    const el = document.getElementById('bt-today-empty');
    if (el) { el.textContent = 'âš  ChÆ°a cÃ³ báº£ng bat_thuong trong Supabase'; el.style.display='block'; }
  }
}

// â”€â”€ Render sidebar theo tab hiá»‡n táº¡i â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBtSidebar() {
  const today = new Date();
  const todayItems = btData.filter(r => {
    if (!r.tg_xuat_hien) return false;
    const d = new Date(r.tg_xuat_hien);
    return d.toDateString() === today.toDateString();
  });
  const chuaItems = btData.filter(r => r.trang_thai === 'ChÆ°a kháº¯c phá»¥c');

  // Cáº­p nháº­t badge count (Æ°u tiÃªn hiá»ƒn thá»‹ sá»‘ chÆ°a xá»­ lÃ½)
  const cntEl = document.getElementById('sb-alert-count');
  if (cntEl) cntEl.textContent = chuaItems.length || btData.length;

  // Render tab today
  renderBtList('bt-today-list', 'bt-today-empty', todayItems,
    todayItems.length === 0 ? 'âœ… KhÃ´ng cÃ³ sá»± cá»‘ má»›i hÃ´m nay' : '');

  // Render tab chua
  renderBtList('bt-chua-list', 'bt-chua-empty', chuaItems,
    chuaItems.length === 0 ? 'âœ… KhÃ´ng cÃ²n sá»± cá»‘ chÆ°a xá»­ lÃ½' : '');
}

function renderBtList(listId, emptyId, items, emptyMsg) {
  const list  = document.getElementById(listId);
  const empty = document.getElementById(emptyId);
  if (!list) return;

  if (!items.length) {
    if (empty) { empty.textContent = emptyMsg; empty.style.display = 'block'; }
    list.innerHTML = '';
    return;
  }
  if (empty) empty.style.display = 'none';

  list.innerHTML = items.slice(0, 15).map(r => {
    const isChua = r.trang_thai === 'ChÆ°a kháº¯c phá»¥c';
    const tram   = r.tram || r.tb_cha || 'â€”';
    const tg     = r.tg_xuat_hien ? fmtBtTime(r.tg_xuat_hien) : '';
    return `<div class="bt-item" onclick="openAlertPanel()">
      <div class="bt-item-hd">
        <div class="bt-dot ${isChua?'chua':'da'}"></div>
        <div class="bt-tram">${escHtml(tram)}</div>
        <div class="bt-time">${tg}</div>
      </div>
      <div class="bt-dien-bien">${escHtml(r.dien_bien||'')}</div>
    </div>`;
  }).join('');
}

function fmtBtTime(v) {
  try {
    const d = new Date(v);
    if (isNaN(d)) return '';
    return d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
  } catch { return ''; }
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchBtTab(tab) {
  btTab = tab;
  document.getElementById('tab-today').classList.toggle('active', tab==='today');
  document.getElementById('tab-chua').classList.toggle('active',  tab==='chua');
  document.getElementById('bt-panel-today').style.display = tab==='today' ? 'block' : 'none';
  document.getElementById('bt-panel-chua').style.display  = tab==='chua'  ? 'block' : 'none';
}

// â”€â”€ Iframe panel: Má»Ÿ bat-thuong-van-hanh.html bÃªn trong Dashboard â”€â”€
function openAlertPanel() {
  const panel = document.getElementById('iframe-panel');
  const frame = document.getElementById('bt-iframe');
  if (!panel || !frame) return;

  // Láº§n Ä‘áº§u má»Ÿ â†’ load trang, truyá»n credentials qua postMessage
  if (!frame.src || frame.src === window.location.href) {
    frame.src = 'bat-thuong-van-hanh.html';
    // Sau khi iframe load xong â†’ gá»­i credentials
    frame.onload = () => {
      const url = localStorage.getItem('tba_url');
      const key = localStorage.getItem('tba_key');
      if (url && key) {
        frame.contentWindow.postMessage({ type:'bt_connect', url, key }, '*');
      }
    };
  }
  panel.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function openAlertPage() { openAlertPanel(); }

function closeAlertPanel() {
  const panel = document.getElementById('iframe-panel');
  if (panel) panel.classList.remove('open');
  document.body.style.overflow = '';
}

// Nháº­n data tá»« iframe bat-thuong Ä‘á»ƒ cáº­p nháº­t badge
window.addEventListener('message', e => {
  if (e.data?.type === 'bt_data') {
    const cntEl = document.getElementById('sb-alert-count');
    if (cntEl) cntEl.textContent = e.data.chua || e.data.total || 'â€”';
    // Cáº­p nháº­t láº¡i sidebar náº¿u cÃ³ data má»›i
    if (e.data.chua_items || e.data.today_items) {
      // GhÃ©p data tá»« iframe vÃ o sidebar
      const chuaList  = document.getElementById('bt-chua-list');
      const todayList = document.getElementById('bt-today-list');
      if (chuaList && e.data.chua_items) {
        chuaList.innerHTML = e.data.chua_items.map(r => btItemHtml(r, true)).join('');
        const emp = document.getElementById('bt-chua-empty');
        if (emp) emp.style.display = e.data.chua_items.length?'none':'block';
      }
      if (todayList && e.data.today_items) {
        todayList.innerHTML = e.data.today_items.map(r => btItemHtml(r, r.trang_thai==='ChÆ°a kháº¯c phá»¥c')).join('');
        const emp = document.getElementById('bt-today-empty');
        if (emp) emp.style.display = e.data.today_items.length?'none':'block';
      }
    }
  }
});

function btItemHtml(r, isChua) {
  return `<div class="bt-item" onclick="openAlertPanel()">
    <div class="bt-item-hd">
      <div class="bt-dot ${isChua?'chua':'da'}"></div>
      <div class="bt-tram">${escHtml(r.tram||'â€”')}</div>
    </div>
    <div class="bt-dien-bien">${escHtml(r.dien_bien||'')}</div>
  </div>`;
}

function exportAbnormal() { openAlertPanel(); }

// â”€â”€ Khá»Ÿi táº¡o max-height cho section bodies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  ['sb-sec-info','sb-sec-alert'].forEach(id => {
    const body = document.getElementById(id)?.querySelector('.sb-section-body');
    if (body) body.style.maxHeight = '600px'; // Äáº·t cá»‘ Ä‘á»‹nh thay vÃ¬ scrollHeight
  });
});

</script>
</body>
</html>
